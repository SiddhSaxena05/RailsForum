steps:
  - id: "build image"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: 'bash'
    args: ["-c", "docker build --build-arg MASTER_KEY=$$RAILS_KEY -t ${_IMAGE_NAME} . "]
    secretEnv: ["RAILS_KEY"]

  - id: "push image"
    name: "gcr.io/cloud-builders/docker"
    args: ["push", "${_IMAGE_NAME}"]

  - id: "apply migrations"
    name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: /bin/bash
    secretEnv: ["RAILS_KEY"]
    args:
      - "-c"
      - |
        gcloud run jobs delete migrate-job --region ${_REGION} -q || true
        gcloud run jobs create migrate-job \
          --region ${_REGION} \
          --image ${_IMAGE_NAME} \
          --set-cloudsql-instances ${_CLOUD_SQL_CONNECTION_NAME} \
          --set-env-vars "RAILS_MASTER_KEY=$$RAILS_KEY,PRODUCTION_DB_NAME=${_PRODUCTION_DB_NAME},PRODUCTION_DB_USERNAME=${_PRODUCTION_DB_USERNAME},CLOUD_SQL_CONNECTION_NAME=${_CLOUD_SQL_CONNECTION_NAME},GOOGLE_PROJECT_ID=${_GOOGLE_PROJECT_ID},STORAGE_BUCKET_NAME=${_STORAGE_BUCKET_NAME},DB_SOCKET_DIR=/cloudsql" \
          --command bundle \
          --args exec,rails,db:migrate \
          --execute-now --wait && \
        gcloud run jobs delete migrate-job --region ${_REGION} -q

options:
  dynamicSubstitutions: true

substitutions:
  _REGION: us-east1
  _SERVICE_NAME: rails-forum
  _INSTANCE_NAME: rb-forum-psql
  _SECRET_NAME: rb-forum-secret
  _AR_REPO_NAME: cloud-run-source-deploy
  _IMAGE_NAME: ${_REGION}-docker.pkg.dev/${PROJECT_ID}/${_AR_REPO_NAME}/${_SERVICE_NAME}
  _CLOUD_SQL_CONNECTION_NAME: ${PROJECT_ID}:${_REGION}:${_INSTANCE_NAME}
  _PRODUCTION_DB_NAME: rb-forum-db
  _PRODUCTION_DB_USERNAME: siddh
  _GOOGLE_PROJECT_ID: rb-forum
  _STORAGE_BUCKET_NAME: rb-forum-bucket

availableSecrets:
  secretManager:
  - versionName: projects/${PROJECT_ID}/secrets/${_SECRET_NAME}/versions/latest
    env: RAILS_KEY

images:
  - "${_IMAGE_NAME}"

